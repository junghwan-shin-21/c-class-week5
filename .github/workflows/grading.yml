name: Grading Assignment Q-1

on: [push]

jobs:
  grade-assignment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Compile the code
        run: gcc main.c -o main 
        
      - name: Run Test Cases and Check Output
        id: code_test
        run: |
          # 1. í…ŒìŠ¤íŠ¸ ì…ë ¥ ì‹œí€€ìŠ¤
          TEST_INPUT="21\n37\n45\n93\n0\n"

          # 2. ì˜ˆìƒ ì¶œë ¥ ì •ì˜ (í”„ë¡¬í”„íŠ¸ì™€ ë§ˆì§€ë§‰ ì…ë ¥ '0'ì„ ëª¨ë‘ ì œê±°í•œ ìˆœìˆ˜í•œ ê²°ê³¼ë§Œ ë‚¨ê¹€)
          EXPECTED_STATIC_OUTPUT_CONTENT="21: ë¹„ì†Œìˆ˜\n37: ì†Œìˆ˜\n45: ë¹„ì†Œìˆ˜\n93: ë¹„ì†Œìˆ˜\n===========\nì¢…ë£Œ\nì†Œìˆ˜ íŒë³„ íšŸìˆ˜: 4íšŒ\n"
          
          # 3. ì‹¤ì œ ì½”ë“œ ì‹¤í–‰ ë° ì¶œë ¥ ìº¡ì²˜
          ACTUAL_OUTPUT=$(echo -e "$TEST_INPUT" | ./main)
          echo "$ACTUAL_OUTPUT" > actual_output.txt

          # 4. ì¶œë ¥ í›„ì²˜ë¦¬ (ëª¨ë“  'ì •ìˆ˜ ì…ë ¥: ' í”„ë¡¬í”„íŠ¸ë¥¼ ì œê±°)
          PROCESSED_OUTPUT=$(echo "$ACTUAL_OUTPUT" | sed 's/ì •ìˆ˜ ì…ë ¥: //g' | sed 's/\r//g')
          
          # 5. ì¶œë ¥ ë¹„êµ ë¡œì§ ì´ˆê¸°í™”
          TEST_RESULT="fail"
          GRADING_RESULT="output_fail" # ê¸°ë³¸ ì‹¤íŒ¨ ì‚¬ìœ : í”„ë¡œê·¸ë¨ ì¶œë ¥ ë¬¸ì œ
          EXEC_TIME_PATTERN="ì‹¤í–‰ì‹œê°„: [0-9]+\.[0-9]{6}ì´ˆ"

          # 5.1. ì²˜ë¦¬ëœ ì¶œë ¥ì—ì„œ ì •ì  ë¶€ë¶„ë§Œ ì¶”ì¶œ (head -n 7)
          ACTUAL_STATIC_LINES=$(echo "$PROCESSED_OUTPUT" | head -n 7)
          
          # 5.2. íŒŒì¼ë¡œ ì €ì¥ (EOF ì¼ì¹˜)
          echo -n "$ACTUAL_STATIC_LINES" > actual_static_output.txt
          echo -n -e "$EXPECTED_STATIC_OUTPUT_CONTENT" > expected_static_output.txt

          # 5.3. diff ë¹„êµ
          if diff -qaw expected_static_output.txt actual_static_output.txt; then
            
            # diff ì„±ê³µ ì‹œ, ë§ˆì§€ë§‰ ì‹¤í–‰ì‹œê°„ í˜•ì‹ë§Œ ê²€ì‚¬
            if echo "$ACTUAL_OUTPUT" | tail -n 1 | grep -E "$EXEC_TIME_PATTERN"; then
              TEST_RESULT="success"
              GRADING_RESULT="success" # ìµœì¢… ì„±ê³µ
            fi
            
          else
            echo "::error::âŒ Test Failed: Output Mismatch (diff check failed)."
            echo "--- Diff Output ---"
            diff expected_static_output.txt actual_static_output.txt
            echo "-------------------"
            # GRADING_RESULTëŠ” ì´ë¯¸ "output_fail"ë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ
          fi

          # 6. ğŸš¨ ì£¼ì„ ê°œìˆ˜ ê²€ì‚¬ (Fail-Fast Overwrite)
          MIN_COMMENTS=4
          # //, /*, */ ë“±ì˜ ì£¼ì„ ë§ˆì»¤ê°€ í¬í•¨ëœ ëª¨ë“  ì¤„ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
          CURRENT_COMMENTS=$(grep -c -E '//|/\*|\*/' main.c)

          if [ "$CURRENT_COMMENTS" -lt "$MIN_COMMENTS" ]; then
            TEST_RESULT="fail" # ì¶œë ¥ ë¹„êµ ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ìµœì¢… ì‹¤íŒ¨
            GRADING_RESULT="comment_fail" # ìµœì¢… ì‹¤íŒ¨ ì‚¬ìœ : ì£¼ì„ ë¶€ì¡±
            echo "::warning::âš ï¸ Code structure check failed: Comments too few ($CURRENT_COMMENTS / $MIN_COMMENTS)"
          fi
          
          # ìµœì¢… ê²°ê³¼ ì„¤ì •
          echo "result=$TEST_RESULT" >> $GITHUB_OUTPUT
          echo "grading_result=$GRADING_RESULT" >> $GITHUB_OUTPUT # ìƒì„¸ ì‚¬ìœ  ì „ë‹¬
          echo "Test result: $TEST_RESULT"


      # ----------------------------------------------------
      # ìµœì¢… Fail ë³´ì¥ ë° ì‚¬ìœ  ë³´ê³  ë¡œì§
      - name: Final Grading and Failure Trigger
        run: |
          GRADING_RESULT="${{ steps.code_test.outputs.grading_result }}"
          
          if [ "$GRADING_RESULT" == "success" ]; then
            echo "::notice::âœ” ìµœì¢… ì±„ì  í†µê³¼"
          else
            echo "::error::âŒ ìµœì¢… ì±„ì  ì‹¤íŒ¨"
            
            if [ "$GRADING_RESULT" == "comment_fail" ]; then
              echo "::error::ğŸš¨ ì‹¤íŒ¨ ì‚¬ìœ : ì£¼ì„ ë¶€ì¡± (main.c íŒŒì¼ì— ìµœì†Œ 4ê°œì˜ ì£¼ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.)"
            elif [ "$GRADING_RESULT" == "output_fail" ]; then
              echo "::error::ğŸš¨ ì‹¤íŒ¨ ì‚¬ìœ : í”„ë¡œê·¸ë¨ ë™ì‘/ì¶œë ¥ ë¶ˆì¼ì¹˜ (ê²°ê³¼ ê°’ì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.)"
            fi
            
            exit 1 
          fi
